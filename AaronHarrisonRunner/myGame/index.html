<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title> Aaron Harrison Endless Runner</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
//above code was lifted straight from tutorial, seemed useful
//game initialized
var game = new Phaser.Game(800, 600, Phaser.AUTO);

//variables
var cursors;
var menuText;
var controlInstructions;
var player
var uAreDed;
var scoreBox
var score = 0;
var rand;
var blocks;
var blck;
var tracker = 0;
var ed = 0.25;
var music;

//state for the main menu
var MainMenu = function(game){};
MainMenu.prototype = {
    preload: function(){
        console.log('MainMenu: preload');
        //loading texture atlas
        game.load.atlas('atlas', 'assets/atlas.png', 'assets/atlas.json');
        game.load.audio('Chase', 'assets/Chase.mp3');
        
        //game.load.image('sky', 'assets/sky.png');
        //set score back to 0 if game restarts
        score = 0;
        ed = 0.25;
    },
    create: function(){
        console.log('MainMenu: create');
        //game.add.sprite(0, 0, 'sky');
        music = game.add.audio('Chase');
        music.play();
        //music.loopFull(0.8);

        game.add.sprite(0, 0, 'atlas', 'dude');
        //game.stage.backgroundColor = '#aaccee';
        cursors = game.input.keyboard.createCursorKeys();

        //various menu textboxes
        menuText = game.add.text(400, 200, 'Random Blocks Falling from the Sky!', {font: '45px Arial', fill: '#999'});
        menuText.anchor.set(0.5, 0.5);

        controlInstructions = game.add.text(400, 300, 'Spacebar to begin', {font: '30px Arial', fill: '#999'});
        controlInstructions.anchor.set(0.5, 0.5);

        var inputInstruct = game.add.text(400, 350, 'Arrow Keys to move, you go faster moving forward', {font: '28px Arial', fill: '#999'});
        inputInstruct.anchor.set(0.5, 0.5);


        game.sound.setDecodeCallback([Chase], start, this)
    },
    update: function(){
        //main menu logic
        //music.loopFull(0.6);// I don't understand why the song won't loop
        if(game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)){
            game.state.start('GamePlay');
        }
    }
}

var GamePlay = function(game){};
GamePlay.prototype = {
    preload: function(){
        console.log('GamePlay: preload');
        //now loading images
        game.load.image('ground', 'assets/Ground.png');
        game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
        game.load.image('grass', 'assets/grass.png');
        game.load.image('platform', 'assets/platform.png');
        //game.load.image('sprite06', 'assets/sprite06.png');
    },
    create: function(){
        console.log('GamePlay: create');

        //implement arcade
        game.physics.startSystem(Phaser.Physics.ARCADE);

        //I couldn't get it to loop so I had to settle for this
        music.restart();

        //music.destroy();
        //game.cache.removeSound('Chase');

        game.add.sprite(0, 0, 'atlas', '0');
     
        //game.physics.startSystem(Phaser.Physics.ARCADE);
        //game.add.sprite(100, 400, 'sprite06');

        //ground
        platforms = game.add.group();
        platforms.enableBody = true;

        var grass = platforms.create(0, 500, 'grass');
        grass.body.immovable = true;

        //establish player character with physics and gravity
        player = game.add.sprite(100, 400, 'dude');
        game.physics.arcade.enable(player);

        player.body.gravity.y = 400;
        player.body.collideWorldBounds = true;
        player.animations.add('right', [6, 7, 8, 9], 20, true);
        //game.add.sprite(0, 0, 'ground');

        //the things that kill you
        blocks = game.add.group();
        blocks.enableBody = true;

        //I wanted one to spawn above the player, get moving
        blck = blocks.create(50, 50, 'platform');
        blck.scale.setTo(0.25, 1);
        blck.body.gravity.y = 200;
  
        //game.stage.backgroundColor = "#ccddaa";
        scoreBox = game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });
    },
    update: function(){
        rand = game.rnd.realInRange(0, 780);
        //var hitgrass = game.physics.arcade.collide(player, grass);
        game.physics.arcade.overlap(player, blocks, killPlayer, null, this);
        //if(game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)){
            //score = 0;
          //  game.state.start('GameOver');
        //}
        //to give the impression of movement you are always moving to the right
        player.animations.play('right');
        if(cursors.up.isDown){
            //jumping back when that was going to be important
            player.body.velocity.y = -300;
        }
        else if(cursors.right.isDown){
            //you move faster going to the right than going backwards, gotta keep moving
            player.body.velocity.x = 160;
        }
        else if(cursors.left.isDown){
            player.body.velocity.x = -100;
        }
        else{
            //I don't want the player to slide
            player.body.velocity.x = 0;
        }

        //score increases by 1 for every frame
        score += 1;

        //long convoluted code, theres probably some better way to do this but it works and I wanted escalating difficulty
        if(score > 8100){
            ed = 2;
        }
        else if(score > 5400){
            ed = 1;
        }
        else if(score > 2700){
            ed = 0.75;
        }
        else if(score > 900){
            ed = 0.5;
        }
        else if(score > 300){
            ed = 0.4;
        }
        else if(score > 100){
            ed = 0.3;
        }

        tracker += 1;
        if(tracker == 60){//I got this from user nana at http://www.html5gamedevs.com/topic/23013-falling-objects/
            rand = game.rnd.realInRange(0, 750);
            //randomly spawn a block every 60 ticks
            blck = blocks.create(rand, 0, 'platform');
            blck.body.gravity.y = 200;
            blck.scale.setTo(ed, 1);
            tracker -= 60;
        }
        //continuously update score box
        scoreBox.text = 'Score: '+score;
    }
}

function killPlayer(player, blocks){
    //honestly I could have just made this the state change but I can't resist killing the player
    player.kill();
    game.state.start('GameOver');
}

var GameOver = function(game){};
GameOver.prototype = {
    preload: function(){
        console.log('GameOver: preload');
    },
    create: function(){
        console.log('GameOver: create');

        //music won't work for a game over theme
        music.destroy();
        game.cache.removeSound('Chase');

        //didn't feel like getting an asset when I could just do this
        game.stage.backgroundColor = "#bbllee";

        uAreDed = game.add.text(400, 200, 'GAME OVER', {font: '48px Arial', fill: '#999'});
        uAreDed.anchor.set(0.5, 0.5);

        //what your score is, very important
        var finalScore = game.add.text(400, 300, 'Score is: '+score, {font: '16px Arial', fill: '#999'});
        finalScore.anchor.set(0.5, 0.5);

        //keep playing
        controlInstructions = game.add.text(400, 400, 'Spacebar to return to life', {font: '24px Arial', fill: '#999'});
        controlInstructions.anchor.set(0.5, 0.5);
    },
    update: function(){
        //keep playing the game without resetting
        if(game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)){
            game.state.start('MainMenu');
        }
    }
}

//game states keeping track of everything
game.state.add('MainMenu', MainMenu);
game.state.add('GamePlay', GamePlay);
game.state.add('GameOver', GameOver);
game.state.start('MainMenu');



</script>

</body>
</html>